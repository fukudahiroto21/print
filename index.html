<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>計算プリントPDF作成</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <h2>デザイン付き計算プリント作成</h2>
  <p>問題数：10問（固定）</p>
  <br>
  <button id="createPdfBtn">PDFを作成</button>
  <button id="previewPdfBtn">印刷プレビュー</button>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const { jsPDF } = window.jspdf;

      function generatePdf(callback) {
        const img = new Image();
        img.src = "./images/text2.png";
        img.crossOrigin = "anonymous";

        img.onload = () => {
          const doc = new jsPDF({
            orientation: 'landscape',
            unit: 'mm',
            format: 'a4'
          });

          doc.addImage(img, 'PNG', 0, 0, 297, 210);

          const num = 10;
          const questions = [];

          for (let i = 0; i < num; i++) {
            const a = Math.floor(Math.random() * 90) + 10;
            const b = Math.floor(Math.random() * 90) + 10;
            const op = Math.random() > 0.5 ? "+" : "–";
            const left = op === "+" ? a : Math.max(a, b);
            const right = op === "+" ? b : Math.min(a, b);
            questions.push(`${left} ${op} ${right} =`);
          }

          doc.setFont("helvetica");
          doc.setFontSize(45);

          let x = 30;
          let y = 60;
          const lineHeight = 30;

          for (let i = 0; i < questions.length; i++) {
            const question = questions[i];
            let offsetX = x;

            for (let char of question) {
              const adjustY = (char === "–") ? y - 1 : y;
              doc.text(char, offsetX, adjustY);
              offsetX += doc.getTextWidth(char);
            }

            y += lineHeight;
            if ((i + 1) === 5) {
              x += 120;
              y = 60;
            }
          }

          callback(doc);
        };

        img.onerror = () => {
          alert("背景画像（images/text.png）が読み込めませんでした。パスとファイル名を確認してください。");
        };
      }

      document.getElementById("createPdfBtn").addEventListener("click", () => {
        generatePdf(doc => doc.save("keisan_print.pdf"));
      });

      document.getElementById("previewPdfBtn").addEventListener("click", () => {
        generatePdf(doc => {
          const pdfBlob = doc.output("blob");
          const blobUrl = URL.createObjectURL(pdfBlob);
          window.open(blobUrl, "_blank");
        });
      });
    });
  </script>
</body>
</html>
